{% extends 'advisor/base.html' %}

{% block title %}Analyze Query{% endblock %}
{% block page_title %}Analyze Query{% endblock %}

{% block content %}
<div class="analyze-container">
    <div class="connection-badge">
        <svg class="badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <ellipse cx="12" cy="5" rx="9" ry="3" />
            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" />
            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
        </svg>
        <span>{{ connection.name }}</span>
        <span class="badge-separator">â€¢</span>
        <span class="badge-db">{{ connection.database }}</span>
    </div>

    <div class="card">
        <div class="card-content">
            <form method="post" class="analyze-form" id="analyzeForm">
                {% csrf_token %}

                <div class="form-group">
                    <label for="id_query" class="form-label">SQL Query</label>
                    <div class="code-editor-wrapper">
                        {{ form.query }}
                    </div>
                    {% if form.query.errors %}
                    <span class="form-error">{{ form.query.errors.0 }}</span>
                    {% endif %}
                    <span class="form-hint">{{ form.query.help_text }}</span>
                </div>

                <div class="form-group form-checkbox-group">
                    {{ form.test_recommendations }}
                    <label for="id_test_recommendations" class="checkbox-label">
                        Test recommendations with temporary tables
                        <span class="checkbox-hint">{{ form.test_recommendations.help_text }}</span>
                    </label>
                </div>

                <div class="form-actions">
                    <a href="{% url 'advisor:connection_list' %}" class="btn btn-ghost">Cancel</a>
                    <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
                        </svg>
                        Analyze Query
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Analyzing your query...</h3>
            <p id="loadingStatus">Running EXPLAIN ANALYZE...</p>
            <div class="loading-steps">
                <div class="loading-step" data-step="1">
                    <span class="step-icon">1</span>
                    <span class="step-text">Analyzing execution plan</span>
                </div>
                <div class="loading-step" data-step="2">
                    <span class="step-icon">2</span>
                    <span class="step-text">Getting AI recommendations</span>
                </div>
                <div class="loading-step" data-step="3">
                    <span class="step-icon">3</span>
                    <span class="step-text">Testing recommendations</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const form = document.getElementById('analyzeForm');
    const overlay = document.getElementById('loadingOverlay');
    const loadingStatus = document.getElementById('loadingStatus');
    const steps = document.querySelectorAll('.loading-step');

    form.addEventListener('submit', function () {
        overlay.style.display = 'flex';
        document.getElementById('analyzeBtn').disabled = true;

        // Animate through steps
        let currentStep = 1;
        const stepMessages = [
            'Running EXPLAIN ANALYZE...',
            'Getting AI recommendations...',
            'Testing optimizations with temp tables...'
        ];

        const interval = setInterval(() => {
            if (currentStep <= 3) {
                loadingStatus.textContent = stepMessages[currentStep - 1];
                steps.forEach((step, i) => {
                    if (i < currentStep) {
                        step.classList.add('active');
                    }
                });
                currentStep++;
            }
        }, 2000);
    });
</script>
{% endblock %}